<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/mathjs/lib/browser/math.js"></script>
  <link rel="stylesheet" href="styles.css">
  <title>Lens simulator</title>
</head>

<body>
  <!-- Slider for blur control -->
  <input type="range" id="slider" min="0" max="10" value="0" step="0.1" />
  <p>Blur Intensity: <span id="blur-value">0</span></p>

  <!-- Container for Konva stage -->
  <div id="container"></div>

  <script>

    class BeamPoint{
        /**
         * @param {number} x
         * @param {number} y
         * @param {math.matrix} ray
         */
        constructor(x, ray){
            /** @type {number} */
            this.x = x;
            /** @type {number} */
            this.y = ray.subset(math.index(0,0));
            /** @type {math.matrix} */
            this.ray = ray;
        }
        /** 
         * @param {number} dx
         * @param {number} dy
         */
        movePoint(dx, dy){
            this.x += dx;
            this.y += dy;
        }

        getRay(){
            return this.ray;
        }
    };
    
    class OpticalSystem{
        /**
         * @param {array} elements - Array of elements defining Optical system, in order how are they stacked
         */
        constructor(elements){
            /** @type {array} */
            this.elements = elements;
        }

        /**
         * @param {number} index
         */
        at(index){
            return this.elements.at(index);
        }

        len(){
            return this.elements.length();
        }
        /**
         * @param {number} index
         */
        update(index, matrix){
            if(index < 0){
                index = this.elements.length() + index;
            }
            this.elements[index] = matrix;
        }

        /**
         * @param {math.matrix} input
         */
        marchRay(input){
            let x_pos = 0;
            let buffer = [new BeamPoint(x_pos, input)];

            for(let index in this.elements){
                x_pos += this.elements[index].subset(math.index(0,1));
                console.log("matrix: ", this.elements[index]);
                console.log("input: ", buffer.at(-1));
                let temp = math.multiply(this.elements[index], buffer.at(-1).getRay());
                console.log("results: ", temp);
                buffer.push(new BeamPoint(x_pos, temp));
            }
            return buffer;
        }
    };

    function createEnvMatrix(length) {
        return math.matrix([[1, length], [0, 1]]);
    };
    function createLensMatrix(focal_length){
        const power = 1/focal_length;
        return math.matrix([[1, 0], [(-1) * power, 1]]);
    };
    function createInput(y, angle){
        return math.matrix([[y], [angle]]);
    };
    function compute_focus(point){
        return (-1) * point.subset(math.index(0,0)) / point.subset(math.index(1,0)) 
    }
    function prepareSystem(matrices){
        matrices.reverse();
        return matrices.reduce((acc, matrix) => math.multiply(acc, matrix), math.identity(2));
    }

    function stepCompute(input, system_matrices){
        let buffer = [input];
        for(let index in system_matrices){
            console.log("matrix: ", system_matrices[index]);
            console.log("input: ", buffer.at(-1));
            let temp = math.multiply(system_matrices[index], buffer.at(-1));
            console.log("results: ", temp);
            buffer.push(temp);
        }
        return buffer;
    }

    const t1 = createEnvMatrix(15);
    const l1 = createLensMatrix(10);
    const t2 = createEnvMatrix(5);
    const l2 = createLensMatrix(-20);
    const input_vector = createInput(1, 0);


    const beam_vectors = stepCompute(input_vector, [t1,l1,t2,l2]);
    console.log(beam_vectors);

    const system = new OpticalSystem([createEnvMatrix(15), createLensMatrix(10), createEnvMatrix(5), createLensMatrix(-20)]);
    const rays = system.marchRay(input_vector);
    console.log("rays: ", rays);

  </script>
</body>
</html>