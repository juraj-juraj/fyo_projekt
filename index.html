<!DOCTYPE html>
<html lang="en" xml:lang="en">
<head>
  <script src="https://unpkg.com/mathjs/lib/browser/math.js"></script>
  <script type="module" src="konva.js"></script>
  <script type="module" src="rayCalculator.js"></script>

  <link rel="stylesheet" href="styles.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ray Optics Visualization</title>
</head>

<body>
  <div class="container">
    <header>
      <h1>Ray Optics Simulator</h1>
      <p>This tool visualizes how a light ray travels through a series of optical elements using Konva.js.</p>
    </header>

    <div id="visualization">
      <!-- Konva will render the canvas here -->
      <div id="canvas-container"></div>
    </div>

    <div class="controls">
      <div class="sliders">
        <label>
          Ray Angle:
          <input type="range" id="angleSlider" min="-45" max="45" value="0" />
        </label>
        <label>
          Ray Intensity:
          <input type="range" id="intensitySlider" min="0" max="100" value="50" />
        </label>
      </div>

      <div class="textboxes">
        <input type="text" id="textbox1" placeholder="Enter wavelength" />
        <input type="text" id="textbox2" placeholder="Enter medium index" />
      </div>

      <div class="buttons">
        <button id="startBtn">Start</button>
        <button id="resetBtn">Reset</button>
        <button id="addElementBtn">Add Element</button>
      </div>
    </div>
  </div>
  <script type="module">
    import * as RayTracing from './rayCalculator.js';
    import * as Scene from './scene.js';
    import "./konva.js";

    window.addEventListener('resize', function() {
      stage.width(window.innerWidth);
      stage.height(window.innerHeight);
      layer.draw();
    });

    const system = new RayTracing.OpticalSystem([RayTracing.createEnvMatrix(150), RayTracing.createLensMatrix(-100), RayTracing.createEnvMatrix(100), RayTracing.createLensMatrix(50)]);
    const input_vector = RayTracing.createInput(10, 0);
    const rays = system.marchRay(input_vector);
    rays.push(RayTracing.computeFocusPoint(rays.at(-1))); // Fixed the syntax error

    console.log("rays: ", rays);

    console.log("width: " + window.innerWidth);
    console.log("height: " + window.innerHeight);

    // Initialize Konva stage
    const stage = new Konva.Stage({
      container: 'canvas-container',
      width: window.innerWidth,
      height: window.innerHeight,
    });

    const sceneModel = new Scene.Model(stage, window.innerHeight, window.innerWidth);
    sceneModel.batchElements(Scene.drawRay(rays));
    sceneModel.draw();

    // const layer = new Konva.Layer();
    // stage.add(layer);

    // for(let i = 0; i < (rays.length - 1); i++){
    //   const start_ray = rays[i]
    //   const end_ray = rays[i + 1]
    //   // Draw the ray from start_ray to end_ray
    //   const line = new Konva.Line({
    //     points: [start_ray.x, start_ray.y, end_ray.x, end_ray.y],
    //     stroke: 'blue',
    //     strokeWidth: 2,
    //   });
    //   layer.add(line);
    // }

    // // Add a layer to the stage

    // layer.draw();
  </script>
</body>
</html>