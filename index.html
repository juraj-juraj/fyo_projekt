<!DOCTYPE html>
<html lang="en" xml:lang="en">
<head>
  <script src="https://unpkg.com/mathjs/lib/browser/math.js"></script>
  <script type="module" src="konva.js"></script>
  <script type="module" src="rayCalculator.js"></script>

  <link rel="stylesheet" href="styles.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ray Optics Visualization</title>
</head>

<body>
  <div class="container">
    <header>
      <h1>Ray Optics Simulator</h1>
      <p>This tool visualizes how a light ray travels through a series of optical elements using Konva.js.</p>
    </header>

    <div id="visualization">
      <!-- Konva will render the canvas here -->
      <div id="canvas-container"></div>
    </div>

    <div class="controls">
      <div class="sliders">
        <label>
          Ray Angle:
          <input type="range" id="angleSlider" min="-45" max="45" value="0" />
        </label>
        <label>
          Ray Intensity:
          <input type="range" id="intensitySlider" min="0" max="100" value="50" />
        </label>
      </div>

      <div class="textboxes">
        <input type="text" id="textbox1" placeholder="Enter wavelength" />
        <input type="text" id="textbox2" placeholder="Enter medium index" />
      </div>

      <div class="buttons">
        <button id="startBtn">Start</button>
        <button id="resetBtn">Reset</button>
        <button id="addElementBtn">Add Element</button>
      </div>
    </div>
  </div>
  <script type="module">
    import * as RayTracing from './rayCalculator.js';
    import * as Scene from './scene.js';
    import "./konva.js";

    const canvasContainer = document.getElementById('visualization');
    const canvasWidth = canvasContainer.clientWidth;
    const canvasHeight = canvasContainer.clientHeight;

    const convexImage = new Image();
    convexImage.src = './convex.png';
    const concaveImage = new Image();
    concaveImage.src = './concave.png';

        // Initialize Konva stage
    const stage = new Konva.Stage({
      container: 'canvas-container',
      width: canvasWidth,
      height: canvasHeight,
    });
    

    const system = new RayTracing.OpticalSystem([RayTracing.createEnvMatrix(150), RayTracing.createLensMatrix(200), RayTracing.createEnvMatrix(100), RayTracing.createLensMatrix(50)]);
    
    const input_top = RayTracing.createInput(10, 0);
    const top_ray = RayTracing.marchRayToFocus(input_top, system);
    const input_bottom = RayTracing.createInput(-10, 0);
    const bottom_ray = RayTracing.marchRayToFocus(input_bottom, system);

    // const layer = new Konva.Layer();
    // stage.add(layer);
    // const imageObj = new Image();
    // imageObj.src = './convex.png';
    // const konvaImage = new Konva.Image({
    //   x: 0,
    //   y: 0,
    //   image: imageObj,
    //   width: 100,   // Optional: scale the image
    //   height: 200,  // Optional: scale the image
    // });
    // layer.add(konvaImage);
    // const konvaImage2 = new Konva.Image({
    //   x: 100,
    //   y: 0,
    //   image: imageObj,
    //   width: 100,   // Optional: scale the image
    //   height: 200,  // Optional: scale the image
    // });
    // layer.add(konvaImage2);
    // layer.draw();

    const sceneModel = new Scene.Model(stage);
    const lenses_info = system.exportLenses();
    sceneModel.drawLenses(lenses_info, top_ray, convexImage, concaveImage);

    sceneModel.drawRay(top_ray);
    sceneModel.drawRay(bottom_ray);

    sceneModel.draw();


  </script>
</body>
</html>